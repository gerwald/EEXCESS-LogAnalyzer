<html>
<head>
    <meta charset="utf-8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <style>
        body{
            font-family:arial;
        }
        #result .header{
            font-weight:bold;
            padding-top:10px;
        }
        #result .action{
            white-space:nowrap;
        }
        table { border-collapse: collapse; }
        table, th, td {
            border: 1px solid black;
        }
        .showLogline{ margin-right: 10px; }
        .logline{
            display: none;
        }
	</style>
</head>
<body>

<input type="checkbox" id="doAdd">Add values<br>
Select Raw Logfile: <input type="file" id="file-input-raw" multiple /><br />
Select Logfile: <input type="file" id="file-input-processed" multiple /><br>
<button id="download">download</button><input type=text value='Logs' id='downloadCaption' style="width:100px" />
<a id="downloadlink" style="display:none;">download File</a>
<h3>Contents of the file:</h3>
<pre id="file-content"></pre>

<table id="result">
</table>


<script>

var logs = []
function readFileProcessed(fileEvent){
    
    var files = fileEvent.target.files;
    if (files.length == 0) {
        return;
    }
    
    if (!$('#doAdd').is(':checked')){
        logs = [];
        $('#file-content').html('');
        $('#result').empty();
    }
    
    var filesExecuted = 0;
    for (var j=0; j<files.length; j++){
        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            var newList = JSON.parse(contents);
            logs = logs.concat(newList);
            filesExecuted++;
            $('#file-content').html(logs.length + " LogeintrÃ¤ge eingelesen.\r\n");
            if (filesExecuted == files.length)
                printLogs();
        };
        reader.readAsText(files[j]);
    }
}

function readRawFile(fileEvent) {
    
    var files = fileEvent.target.files;
    if (files.length == 0) {
        return;
    }
    
    if (!$('#doAdd').is(':checked')){
        logs = [];
        $('#file-content').html('');
        $('#result').empty();
    }
    
    var filesExecuted = 0;
    for (var j=0; j<files.length; j++){
        var reader = new FileReader();
        reader.onload = function(e) {
            var lines = e.target.result.split(/[\r\n]+/g);
			var logLine, logLineCopy;
            for (var i = 0; i < lines.length; i++) {
                if (lines[i].indexOf('moduleStatisticsCollected') > -1){
                    //output.push('<li>' + lines[i] + '<br>');
                    //console.log(lines[i]);
                    logLine = JSON.parse(lines[i]);
                    logLineCopy = JSON.parse(lines[i]);
                    logLineCopy.content = undefined;
					var logEntry;
                    for (var k=0; k<logLine.content.logs.length; k++){
                        logEntry = logLine.content.logs[k];
                        logEntry.userID = logLine.origin.userID;
                        logEntry.clientType = logLine.origin.clientType;
                        logEntry.ip = logLine.ip;
                        logEntry.logContainer = logLineCopy;
                        logs.push(logEntry);
                    }
                }
            }
            filesExecuted++;
            $('#file-content').html(logs.length + " Logentries found.\r\n");
            if (filesExecuted == files.length)
                printLogs();
        };
        reader.readAsText(files[j], 'iso-8859-1'); //"iso-8859-1", "windows-1252"
    }
}

function printLogs(){
    $header = $('#file-content');
    $header.html('');
    $('#result').empty();
    
    $header.html($header.html() + logs.length + " Logentries found.\r\n");
    var logsPerUser = _.groupBy(logs, function(i){ 
        return i.userID + ' / ' + i.ip ;
    });
    $header.html($header.html() + Object.keys(logsPerUser).length + " Unique Users found.\r\n");
    
    _.forEach(logsPerUser, function(n, key) {
        printLogsForUser(key, logsPerUser[key]);
    });
}

function printHeaderForUser(key, uiState){
	$('#result').append('<tr class=header><td colspan=3>' + key + '</td></tr>');
	$('#result').append('<tr><td colspan=3>' + uiState.browser.name +', '+ uiState.size + '</td></tr>');
}

function printLogsForUser(key, logs){
    printHeaderForUser(key, logs[0].uiState);
    logs = _.sortBy(logs, 'timestamp');
    var timeBefore = null;
    var ipBefore = null;
    for (var j=0; j<logs.length; j++){
        if (ipBefore != null && ipBefore != logs[j].ip){
            printHeaderForUser(key, logs[j].uiState);
        }
        if (logs[j].seq == 1)
            timeBefore = null;
            
        var timeDiff = null;
        if (timeBefore != null)
            timeDiff = (logs[j].timestamp - timeBefore) / 1000
        logLog(logs[j], timeDiff);
        timeBefore = logs[j].timestamp;
    }
}


function logLog(logobject, timeDiff){    
    var text = ''
            //+ logobject.action 
            + (logobject.action == 'Dashboard opened' ? ', Client: ' + logobject.clientType  : '' ) 
            + (logobject.duration ? ', Duration: ' + logobject.duration  : '' ) 
            + (logobject.value ? ', value: ' + logobject.value  : '' )
            //+ (logobject.source ? ', source: ' + logobject.source  : '' )
            + (logobject.component ? ', component: ' + logobject.component  : '' )
            + (logobject.itemTitle ? ', itemTitle: ' + logobject.itemTitle  : '' )
            + (logobject.itemCountOld ? ', itemCountOld: ' + logobject.itemCountOld  : '' )
            + (logobject.itemCountNew ? ', itemCountNew: ' + logobject.itemCountNew  : '' )
            + (logobject.itemCount ? ', itemCount: ' + logobject.itemCount  : '' )
            + (logobject.old ? ', old: ' + logobject.old  : '' )
            + (logobject.new ? ', new: ' + logobject.new  : '' )
            + '\r\n';
            
    //if (logobject.action == 'Mouse over times'){
    //    text = "" + JSON.stringify(logobject.components, null, "\t") + "";
    //}
    if (text.indexOf(', ') == 0)
        text = text.substring(2);
            
    $('#result').append('<tr><td>' + logobject.seq + '</td><td>' + (timeDiff || '') + '</td><td class=action>' + logobject.action + '</td><td>' + text 
        + ' <a href="#" class="showLogline">+</a><pre class="logline">'+ JSON.stringify(logobject, null, "\t") + '</pre></td></tr>');

}

function download() {
	//var element = document.getElementById('downloadlink');
    var element = document.createElement('a');
	document.body.appendChild(element);
	
	var filename = $(downloadCaption).val();
	var i, j, logsPart, chunk = 2500, pad=((logs.length)+'').length;
	for (i=0, j=logs.length; i<j; i+=chunk) {
		logsPart = logs.slice(i, i+chunk);		
		var max = i + chunk;
		if (max > j)
			max = j;
		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(JSON.stringify(logsPart)));
		element.setAttribute('download', filename + '_' + leftPad(i, pad)  + '-' + leftPad(max, pad) + '.json');
		element.style.display = 'none';		
		element.click();
	}  
    document.body.removeChild(element);
}

function leftPad(number, targetLength) {
    var output = number + '';
    while (output.length < targetLength) {
        output = '0' + output;
    }
    return output;
}

$(document).on('ready', function(){
    document.getElementById('file-input-raw').addEventListener('change', readRawFile, false);
    //document.getElementById('file-input-processed').addEventListener('change', readFileProcessed, false);
    $('#download').on('click', function(){
        download();
    });
    $('#file-input-processed').on('change', function(e){
        readFileProcessed(e);
    });
    
    $(document).on('click', '.showLogline', function(e){
        e.preventDefault();
        $(this).next().toggle();
    });
});


  
</script>

</body>
</html>